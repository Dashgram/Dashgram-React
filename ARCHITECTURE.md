# Dashgram React SDK - Architecture

## Overview

The Dashgram React SDK (`@dashgram/react`) is a **thin React-friendly wrapper** around the core `@dashgram/javascript` SDK. It provides idiomatic React patterns (hooks, context, providers) without duplicating any core logic.

## Design Principles

1. **No Duplication** - All business logic lives in `@dashgram/javascript`
2. **React Idioms** - Uses hooks, context, and providers naturally
3. **Type Safety** - Full TypeScript support with proper types
4. **Backwards Compatible** - Doesn't break the core SDK contract
5. **Developer Experience** - Simple, intuitive API

## Architecture

```
┌─────────────────────────────────────┐
│   React Application                 │
│                                     │
│   ┌─────────────────────────────┐   │
│   │  DashgramProvider           │   │
│   │  - Initializes core SDK     │   │
│   │  - Manages React context    │   │
│   │  - Handles lifecycle        │   │
│   └─────────────────────────────┘   │
│              │                       │
│   ┌──────────▼──────────┐           │
│   │  React Hooks        │           │
│   │  - useDashgram()    │           │
│   │  - useTrackEvent()  │           │
│   │  - usePageView()    │           │
│   │  - useAutoTrack()   │           │
│   └──────────┬──────────┘           │
└──────────────┼─────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│   @dashgram/javascript (Core SDK)   │
│   - Event tracking                  │
│   - Batching & flushing             │
│   - Telemetry collection            │
│   - Backend communication           │
└─────────────────────────────────────┘
```

## Key Components

### 1. DashgramProvider

**Location:** `src/provider.tsx`

**Responsibilities:**

- Initialize the core SDK on mount
- Provide React context to children
- Manage SDK lifecycle (init/shutdown)
- Expose SDK methods through context

**Key Features:**

- React 18 Strict Mode compatible (prevents double initialization)
- Automatic cleanup on unmount
- Tracks track level in state for `getTrackLevel()`

### 2. React Hooks

**Location:** `src/hooks.tsx`

#### Core Hooks

- **`useDashgram()`** - Main hook, returns SDK instance and all methods
- **`useTrackEvent()`** - Returns a function to track events imperatively

#### Lifecycle Hooks

- **`useTrackMount()`** - Track when component mounts
- **`useTrackUnmount()`** - Track when component unmounts
- **`useAutoTrack()`** - Automatically track mount/unmount with component name

#### Routing Hooks

- **`usePageView()`** - Track page views (SPA routing)
- **`useScreenTracking()`** - Automatic screen tracking with React Router

#### Helper Hooks

- **`useTrackClick()`** - Returns click handler that tracks events
- **`useTrackSubmit()`** - Returns form submit handler that tracks events

### 3. Types

**Location:** `src/types.ts`

**Exports:**

- `DashgramContextValue` - Context value interface
- `DashgramConfig` - Re-exported from core SDK
- `EventProperties` - Re-exported from core SDK
- `TrackLevel` - Re-exported from core SDK

## Event Flow

1. **User Action** → React component calls hook
2. **Hook** → Calls `track()` from context
3. **Context** → Calls `DashgramMini.track()` from core SDK
4. **Core SDK** → Builds event with telemetry, batches, sends to backend

## Event Schema Compliance

All events conform to the backend contract:

```typescript
interface WebAppEvent {
  eventId: string // UUID generated by core SDK
  type: string // Event name
  initData: string // Telegram initData (from core SDK)
  properties?: unknown // Custom properties
  telemetry?: Telemetry // Auto-collected telemetry
  source?: string // "auto" | "manual"
  level?: number // Track level (1-3)
  timestamp: number // Unix milliseconds
}
```

The React SDK **does not modify** this schema - it passes through to the core SDK which handles all event construction.

## Integration with Core SDK

The React SDK:

✅ **Does:**

- Wrap core SDK initialization
- Provide React-friendly API
- Manage React lifecycle
- Expose core SDK methods through hooks

❌ **Does NOT:**

- Duplicate event building logic
- Modify event schema
- Add new backend endpoints
- Reimplement batching/flushing
- Create new session management

## Type Safety

All components are fully typed:

- Provider props extend `DashgramConfig`
- Context value is strictly typed
- Hooks return properly typed functions
- Event properties are typed as `Record<string, unknown>`

## Testing

Test structure includes:

1. **Type Tests** (`__tests__/types.test.ts`) - Compile-time type checks
2. **Hook Tests** (`__tests__/hooks.test.tsx`) - Hook behavior tests
3. **Provider Tests** (`__tests__/provider.test.tsx`) - Provider lifecycle tests

Run type checking:

```bash
npm run type-check
```

## Backwards Compatibility

The React SDK maintains 100% backwards compatibility with:

- Core SDK API
- Backend event contract
- Existing event schema
- Telemetry format

## Future Enhancements

Potential additions (without breaking changes):

- `useTrackError()` - Automatic error boundary tracking
- `useTrackPerformance()` - Performance metrics tracking
- Custom hook builders for specific use cases
- SSR optimizations

## Dependencies

- **Peer:** `react ^18.0.0`
- **Optional Peer:** `react-router-dom` (for `useScreenTracking`)
- **Runtime:** `@dashgram/javascript ^1.0.0`

No other runtime dependencies - keeps bundle size minimal.
